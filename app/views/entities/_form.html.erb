<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>

<%= form_for @entity , html: {id: :form_id} do |f| %>
  <% if @entity.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@entity.errors.count, "error") %> prohibited this entity from being saved:</h2>

      <ul>
      <% @entity.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= f.label :name %><br>
    <%= f.text_field :name %>
  </div>
  <div class="field">
    <%= f.label :type %><br>
    <%= f.select :type, options_for_select(["Startup", "Investor", "Accelerator", "Co-worker", "R&D Center", "Service"], :selected => @selected_types), {}, {:multiple => true, :class => "multiselect", :style => "width:450px;" } %>
  </div>
  
  <div class="field">
    <%= f.label :lat %><br>
    <%= f.text_field :lat %>
  </div>
  <div class="field">
    <%= f.label :lon %><br>
    <%= f.text_field :lon %>
  </div>
  <div class="field">
    <%= f.label :description %><br>
    <%= f.text_area :description %>
  </div>
  <div class="field">
    <%= f.label :url %><br>
    <%= f.text_field :url %>
  </div>
  <div class="field">
    <%= f.label :address %><br>
    <%= f.text_field :address %>
  </div>
  <div class="field">
    <%= f.label :year_estab %><br>
    <%= f.text_field :year_estab %>
  </div>
  <div class="field">
    <%= f.label :user_id %><br>
    <%= f.text_field :user_id %>
  </div>

  <div class="field">
    <%= f.label :admin_verification %><br>
    <%= f.text_field :admin_verification %>
  </div>

<!-- Map goes here-->
<div style='width: 800px;'>
  <div id="multi_markers" style='width: 800px; height: 400px;'></div>
</div>


  <div class="actions">
    <%= f.submit %>
  </div>


<script type="text/javascript">
  $(document).ready(function() {
    $('.multiselect').multiselect({

    
    onChange: function(option, checked) {
    // Get selected options.
    var selectedOptions = $('.multiselect option:selected');
     
    if (selectedOptions.length >= 3) {
    // Disable all other checkboxes.
    var nonSelectedOptions = $('.multiselect option').filter(function() {
    return !$(this).is(':selected');
    });
     
    var dropdown = $('.multiselect').siblings('.multiselect-container');
    nonSelectedOptions.each(function() {
    var input = $('input[value="' + $(this).val() + '"]');
    input.prop('disabled', true);
    input.parent('li').addClass('disabled');
    });
    }
    else {
    // Enable all checkboxes.
    var dropdown = $('.multiselect').siblings('.multiselect-container');
    $('.multiselect option').each(function() {
    var input = $('input[value="' + $(this).val() + '"]');
    input.prop('disabled', false);
    input.parent('li').addClass('disabled');
    });
    }
    }
    });
  });
</script>



<script type="text/javascript">
  var mapStyles = [
         {
            featureType: "road",
            elementType: "geometry",
            stylers: [
              { hue: "#8800ff" },
              { lightness: 100 }
            ]
          },{
            featureType: "road",
            stylers: [
              { visibility: "on" },
              { hue: "#91ff00" },
              { saturation: -62 },
              { gamma: 1.98 },
              { lightness: 45 }
            ]
          },{
            featureType: "water",
            stylers: [
              { hue: "#005eff" },
              { gamma: 0.72 },
              { lightness: 42 }
            ]
          },{
            featureType: "transit.line",
            stylers: [
              { visibility: "off" }
            ]
          },{
            featureType: "administrative.locality",
            stylers: [
              { visibility: "on" }
            ]
          },{
            featureType: "administrative.neighborhood",
            elementType: "geometry",
            stylers: [
              { visibility: "simplified" }
            ]
          },{
            featureType: "landscape",
            stylers: [
              { visibility: "on" },
              { gamma: 0.41 },
              { lightness: 46 }
            ]
          },{
            featureType: "administrative.neighborhood",
            elementType: "labels.text",
            stylers: [
              { visibility: "on" },
              { saturation: 33 },
              { lightness: 20 }
            ]
          }
        ];

        var zoomControl = true;
        var mapOptions = {
            zoom: 7,
            //minZoom: 10,
            center: new google.maps.LatLng(30.06,31.25),
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            streetViewControl: false,
            mapTypeControl: false,
            panControl: false,
            zoomControl: zoomControl,
            styles: mapStyles,
            zoomControlOptions: {
            style: google.maps.ZoomControlStyle.SMALL,
            position: google.maps.ControlPosition.LEFT_CENTER
          }
        }
        var markers;
        var handler = Gmaps.build('Google');
        handler.buildMap({
          provider: mapOptions,
          internal: {
          id: 'multi_markers'
           }
        }, function(){
        

          if($('#entity_lat').attr("value") != null)
          {
          markers = handler.addMarkers([
            {
              "lat": $('#entity_lat').attr("value"),
              "lng": $('#entity_lon').attr("value"),
              "title": "Your Company",
              "infowindow": "<b> Your Company <b> "
            }
          ]);
        }

        google.maps.event.addListener(handler.getMap(), "rightclick", function(event) {


          alert( $('#entity_lat'));

          var lat = event.latLng.lat();
          var lng = event.latLng.lng();
          $('#entity_lat').val(lat);
          $('#entity_lon').val(lng);
          
          
          handler.removeMarkers(markers);
          
          //add a marker

          markers = handler.addMarkers([
            {
              "lat": event.latLng.lat(),
              "lng": event.latLng.lng(),
              "title": "Your Company",
              "infowindow": "<b> Your Company <b> "
            }
          ]);
          //alert("Lat=" + lat + "; Lng=" + lng);
        });

        handler.fitMapToBounds();
        });
</script>


<% end %>



<!-- id="entity_lat" -->

<!-- id="entity_lon" -->